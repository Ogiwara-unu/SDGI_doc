# Base de Datos


**Base de Datos:** Oracle DataBase

**Motor de Base de Datos:** Oracle Database Engine

### Scripts de Tablas

 **Empleados**

```sql
CREATE TABLE  "EMP" 
   (	"EMPNO" NUMBER(4,0) NOT NULL ENABLE, 
	"ENAME" VARCHAR2(10), 
	"JOB" VARCHAR2(9), 
	"MGR" NUMBER(4,0), 
	"HIREDATE" DATE, 
	"SAL" NUMBER(7,2), 
	"COMM" NUMBER(7,2), 
	"DEPTNO" NUMBER(2,0), 
	 PRIMARY KEY ("EMPNO")
  USING INDEX  ENABLE
   )
/
ALTER TABLE  "EMP" ADD FOREIGN KEY ("MGR")
	  REFERENCES  "EMP" ("EMPNO") ENABLE
/
ALTER TABLE  "EMP" ADD FOREIGN KEY ("DEPTNO")
	  REFERENCES  "DEPT" ("DEPTNO") ENABLE
/
```
**Dispositivos**
```sql
CREATE TABLE  "DISPOSITIVOS_ATRIBUTOS" 
   (	"ID_ATRIBUTO" NUMBER, 
	"DESCRIPCION" VARCHAR2(50) NOT NULL ENABLE, 
	"FORMATO" VARCHAR2(50), 
	"ID_TIPO_DISPOSITIVO" NUMBER NOT NULL ENABLE, 
	 PRIMARY KEY ("ID_ATRIBUTO")
  USING INDEX  ENABLE
   )
/
ALTER TABLE  "DISPOSITIVOS_ATRIBUTOS" ADD FOREIGN KEY ("ID_TIPO_DISPOSITIVO")
	  REFERENCES  "TIPO_DISPOSITIVO" ("ID_CODIGO_DISPOSITIVO") ENABLE
/

CREATE UNIQUE INDEX  "UQ_NOMBRE_UPPER_TD_DIS_ATRI" ON  "DISPOSITIVOS_ATRIBUTOS" (UPPER("DESCRIPCION"), "ID_TIPO_DISPOSITIVO")
/

```
**Inventario Dispositivos**
```sql
CREATE TABLE  "INVENTARIO_DISPOSITIVO" 
   (	"ID_INVENTARIO_DISPOSITIVO" NUMBER, 
	"MODELO" NUMBER(*,0) NOT NULL ENABLE, 
	"MARCA" NUMBER(*,0) NOT NULL ENABLE, 
	"ESTADO" CHAR(1) NOT NULL ENABLE, 
	"DESCRIPCION" VARCHAR2(150), 
	"SERIAL" VARCHAR2(100), 
	"FECHA_INGRESO" DATE NOT NULL ENABLE, 
	"FECHA_SALIDA" DATE, 
	"NOTAS" VARCHAR2(100), 
	"PROXIMO_MANTENIMIENTO" DATE, 
	"ID_TIPO_DISPOSITIVO" NUMBER NOT NULL ENABLE, 
	 PRIMARY KEY ("ID_INVENTARIO_DISPOSITIVO")
  USING INDEX  ENABLE, 
	 CONSTRAINT "UQ_SERIAL" UNIQUE ("SERIAL")
  USING INDEX  ENABLE
   )
/
ALTER TABLE  "INVENTARIO_DISPOSITIVO" ADD FOREIGN KEY ("ID_TIPO_DISPOSITIVO")
	  REFERENCES  "TIPO_DISPOSITIVO" ("ID_CODIGO_DISPOSITIVO") ENABLE
/
ALTER TABLE  "INVENTARIO_DISPOSITIVO" ADD FOREIGN KEY ("MARCA")
	  REFERENCES  "MARCAS" ("ID_MARCA") ENABLE
/
ALTER TABLE  "INVENTARIO_DISPOSITIVO" ADD FOREIGN KEY ("MODELO")
	  REFERENCES  "MODELO" ("ID_MODELO") ENABLE
/

```
**Mantenimiento Dispositivos**
```sql
CREATE TABLE  "MANTENIMIENTO_DISPOSITIVO" 
   (	"ID_MANTENIMIENTO_DISPOSITIVO" NUMBER, 
	"FECHA" DATE NOT NULL ENABLE, 
	"ESTADO_DISPOSITIVO" CHAR(1) NOT NULL ENABLE, 
	"TIPO_MANTENIMIENTO" CHAR(1) NOT NULL ENABLE, 
	"OBSERVACIONES" VARCHAR2(100), 
	"CODIGO" VARCHAR2(100), 
	"ESTADO_MANTENIMIENTO" CHAR(1) NOT NULL ENABLE, 
	"ID_TECNICO" NUMBER NOT NULL ENABLE, 
	"ID_DISPOSITIVO" NUMBER NOT NULL ENABLE, 
	 PRIMARY KEY ("ID_MANTENIMIENTO_DISPOSITIVO")
  USING INDEX  ENABLE
   )
/
ALTER TABLE  "MANTENIMIENTO_DISPOSITIVO" ADD FOREIGN KEY ("ID_TECNICO")
	  REFERENCES  "MANTENIMIENTO_EMPLEADOS" ("NUM_EMPLEADO") ENABLE
/
ALTER TABLE  "MANTENIMIENTO_DISPOSITIVO" ADD FOREIGN KEY ("ID_DISPOSITIVO")
	  REFERENCES  "INVENTARIO_DISPOSITIVO" ("ID_INVENTARIO_DISPOSITIVO") ENABLE
/

CREATE OR REPLACE TRIGGER  "TRG_DEL_DET" 
BEFORE DELETE ON MANTENIMIENTO_DISPOSITIVO 
REFERENCING OLD AS OLD NEW AS NEW 
FOR EACH ROW
BEGIN
  DELETE FROM DETALLE_MANTENIMIENTO_CL 
  WHERE ID_DETALLE_MANTENIMIENTO = :OLD.ID_MANTENIMIENTO_DISPOSITIVO;
END;
/
ALTER TRIGGER  "TRG_DEL_DET" ENABLE
/

CREATE OR REPLACE TRIGGER  "TRG_FIN_MANT" 
BEFORE UPDATE OR INSERT ON MANTENIMIENTO_DISPOSITIVO 
REFERENCING OLD AS OLD NEW AS NEW 
FOR EACH ROW
DECLARE
    V_CANT_T NUMBER(3,0);   --PARA ALMACENAR LA CANTIDAD DE TAREAS
    V_DIAS_MANT NUMBER;
BEGIN
  IF :NEW.ESTADO_MANTENIMIENTO =  'R' THEN
    --Cuenta Tareas Pendientes Del Mantenimiento
    SELECT COUNT(ID_TAREA)
    INTO V_CANT_T
    FROM DETALLE_MANTENIMIENTO_CL
    WHERE 
        ID_DETALLE_MANTENIMIENTO = :NEW.ID_MANTENIMIENTO_DISPOSITIVO
        AND ESTADO = 'PE';
    
    IF V_CANT_T > 0 THEN --Si tiene tareas pendientes
        RAISE_APPLICATION_ERROR(-20001, 'Tiene tareas pendientes por realizar al mantenimiento.');
    ELSE
        SELECT 
            T.PERIODICIDAD
        INTO V_DIAS_MANT
        FROM  
            INVENTARIO_DISPOSITIVO IN_D
            LEFT JOIN TIPO_DISPOSITIVO T ON T.ID_CODIGO_DISPOSITIVO = IN_D.ID_TIPO_DISPOSITIVO
        WHERE 
            IN_D.ID_INVENTARIO_DISPOSITIVO = :NEW.ID_DISPOSITIVO;
    
        UPDATE INVENTARIO_DISPOSITIVO
        SET PROXIMO_MANTENIMIENTO = SYSDATE + V_DIAS_MANT
        WHERE ID_INVENTARIO_DISPOSITIVO = :NEW.ID_DISPOSITIVO;
    END IF;
  END IF;
END;
/
```


### Triggers Principales

**Empleado**
```sql
CREATE OR REPLACE TRIGGER  "EMP_TRG1" 
              before insert on emp
              for each row
              begin
                  if :new.empno is null then
                      select emp_seq.nextval into :new.empno from sys.dual;
                 end if;
              end;
```

**Dispositivo**
```sql
CREATE OR REPLACE TRIGGER  "TRG_ATRIBUTO_DISPOSITIVO_AI" 
BEFORE INSERT ON DISPOSITIVOS_ATRIBUTOS
FOR EACH ROW
BEGIN
    SELECT NVL(MAX(ID_ATRIBUTO), 0) + 1
    INTO :NEW.ID_ATRIBUTO
    FROM DISPOSITIVOS_ATRIBUTOS;
END;
```
**Inventario Dispositivos (Periocidad)**
```sql
CREATE OR REPLACE TRIGGER  "TRG_AUTO_PERIODICIDAD" 
before insert 
on inventario_dispositivo
for each row
declare v_periodicidad number;
begin
    SELECT periodicidad into v_periodicidad from tipo_dispositivo
    where id_codigo_dispositivo = :NEW.ID_TIPO_DISPOSITIVO;

    :NEW.PROXIMO_MANTENIMIENTO := :new.fecha_ingreso + v_periodicidad;    
end;
```
**Inventario Dispositivos (Fechas)**
```sql
CREATE OR REPLACE TRIGGER  "TRG_FECHAS_INVENTARIO_DIS" 
BEFORE
insert or update on "INVENTARIO_DISPOSITIVO"
for each row
begin
BEGIN
   IF :NEW.FECHA_INGRESO > :NEW.FECHA_SALIDA THEN
      RAISE_APPLICATION_ERROR(-20002, 'La fecha de ingreso no puede ser mayor que la fecha de salida');
   END IF;
END;

end;
```
**Inventario Dispositivos (Marcas)**
```sql
CREATE OR REPLACE TRIGGER  "TRG_MARCAXMODELO_INV_DIS" 
BEFORE INSERT ON INVENTARIO_DISPOSITIVO
FOR EACH ROW 
DECLARE 
    v_marca INT;
BEGIN
    -- Obtener el ID_MARCA del modelo especificado.
    SELECT ID_MARCA INTO v_marca 
    FROM MODELO
    WHERE ID_MODELO = :NEW.MODELO;

    -- Verificar si la marca del modelo coincide con la marca de la inserci칩n.
    IF v_marca != :NEW.MARCA THEN
        -- Si no coincide, lanzar un error y evitar el INSERT.
        RAISE_APPLICATION_ERROR(-20001, 'La marca no coincide con el modelo.');
    END IF;

    -- Si coincide, el insert continuar치 normalmente.
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        -- Si no se encontr칩 el modelo, lanzar un error.
        RAISE_APPLICATION_ERROR(-20002, 'No se encontr칩 el modelo.');
    WHEN OTHERS THEN
        -- Cualquier otro error inesperado.
        RAISE_APPLICATION_ERROR(-20003, 'Error inesperado: ' || SQLERRM);
END;
```
**Mantenimiento Dispositivos (Bloqueo)** 
```sql
CREATE OR REPLACE TRIGGER  "TRG_MANTE_DISPOSITIVO_AI" 
BEFORE INSERT ON MANTENIMIENTO_DISPOSITIVO
FOR EACH ROW
BEGIN
/*
    SELECT NVL(MAX(ID_MANTENIMIENTO_DISPOSITIVO), 0) + 1
    INTO :NEW.ID_MANTENIMIENTO_DISPOSITIVO
    FROM MANTENIMIENTO_DISPOSITIVO;
*/
DECLARE
    v_max_id NUMBER;
BEGIN
    -- Bloquea la tabla solo mientras se asigna el nuevo ID
    LOCK TABLE MANTENIMIENTO_DISPOSITIVO IN EXCLUSIVE MODE;

    SELECT NVL(MAX(ID_MANTENIMIENTO_DISPOSITIVO), 0) + 1
    INTO v_max_id
    FROM MANTENIMIENTO_DISPOSITIVO;

    :NEW.ID_MANTENIMIENTO_DISPOSITIVO := v_max_id;
END;
END;
```

